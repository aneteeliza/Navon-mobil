<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Navon Task</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <link href="https://unpkg.com/jspsych@6.3.1/css/jspsych.css" rel="stylesheet">

  <style>
    body {
      background-color: black;
      color: white;
      font-family: monospace;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    .navon-letter {
      display: inline-block;
      text-align: center;
      opacity: 0;
      animation: fadein 0.2s forwards;
    }

    @keyframes fadein {
      from { opacity: 0; transform: scale(0.6); }
      to { opacity: 1; transform: scale(1); }
    }

    .mobile-btn {
      font-size: 26px;
      width: 130px;
      height: 70px;
      margin: 15px;
    }
  </style>
</head>

<body>

<script src="https://unpkg.com/jspsych@6.3.1/jspsych.js"></script>
<script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
<script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-html-button-response.js"></script>

<script>


const IS_MOBILE = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);


function generateParticipantID() {
  return "NAVON-" + Math.random().toString(36).substring(2, 8).toUpperCase();
}

const PARTICIPANT_ID = generateParticipantID();
const TIMESTAMP = new Date().toISOString();

jsPsych.data.addProperties({
  participant_id: PARTICIPANT_ID,
  timestamp: TIMESTAMP,
  device: IS_MOBILE ? "mobile" : "desktop"
});

const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbxeNwAiyIZQZJ6iMkwZ44yMFJ1H3oT5nUWNjzPUKzMeQFVE7Y3c0-xz6-CGbB63cwg96g/exec";

const N_TRIALS_GLOBAL = 20;
const N_TRIALS_LOCAL  = 20;
const N_TRIALS_MIXED  = 40;

const GLOBAL_LETTERS = ["H", "S"];
const GRID_SIZE = 9;


const TEMPLATES = {
  "H":[
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1]
  ],
  "S":[
    [0,1,1,1,1,1,1,1,0],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0],
    [0,1,0,0,0,0,0,0,0],
    [0,0,1,1,1,1,1,0,0],
    [0,0,0,0,0,0,0,1,0],
    [0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1],
    [0,1,1,1,1,1,1,1,0]
  ]
};


function generateNavonHTML(global_letter, local_letter){
  const template = TEMPLATES[global_letter];
  const colors = ["white", "yellow", "cyan", "magenta", "lime"];
  const size = Math.min(window.innerWidth / 12, 28);

  let html = '<div style="display:inline-block;">';

  for(let r=0;r<GRID_SIZE;r++){
    html += '<div>';
    for(let c=0;c<GRID_SIZE;c++){
      if(template[r][c]===1){
        const color = colors[Math.floor(Math.random()*colors.length)];
        html += `<span class="navon-letter"
                  style="color:${color};
                         font-size:${size}px;
                         width:${size}px;
                         height:${size}px;">${local_letter}</span>`;
      } else {
        html += `<span class="navon-letter"
                  style="width:${size}px;
                         height:${size}px;">&nbsp;</span>`;
      }
    }
    html += '</div>';
  }
  html += '</div>';
  return html;
}


function instructionScreen(htmlText){
  return IS_MOBILE
    ? {
        type: "html-button-response",
        stimulus: htmlText,
        choices: ["TURPINĀT"],
        data: {ignore:true}
      }
    : {
        type: "html-keyboard-response",
        stimulus: htmlText,
        choices: [" "],
        data: {ignore:true}
      };
}


function createTrials(block_type, n_trials, fixed_task=null){
  const trials = [];

  for(let i=0;i<n_trials;i++){

    let task = fixed_task || (block_type==="mixed" ? (Math.random()<0.5?"global":"local") : fixed_task);
    let condition = Math.random()<0.5 ? "congruent" : "incongruent";

    let global_letter, local_letter;

    if(condition==="congruent"){
      global_letter = local_letter = GLOBAL_LETTERS[Math.floor(Math.random()*2)];
    } else {
      const shuffled = [...GLOBAL_LETTERS].sort(()=>Math.random()-0.5);
      global_letter = shuffled[0];
      local_letter  = shuffled[1];
    }

    if(block_type==="mixed"){
      trials.push({
        type: IS_MOBILE ? "html-button-response" : "html-keyboard-response",
        stimulus: `<div style="font-size:80px; color:yellow;">${task==="global"?"↑":"↓"}</div>`,
        choices: IS_MOBILE ? [] : jsPsych.NO_KEYS,
        trial_duration: 700,
        data:{ignore:true}
      });
    }

    trials.push(
      IS_MOBILE
      ? {
          type: "html-button-response",
          stimulus: generateNavonHTML(global_letter, local_letter),
          choices: ["H","S"],
          button_html: `<button class="jspsych-btn mobile-btn">%choice%</button>`,
          trial_duration: 1500,
          data: {block:block_type,trial:i+1,condition,task,global_letter,local_letter},
          on_finish:function(data){
            const correct = (task==="global"?global_letter:local_letter);
            data.response = data.response===0?"H":"S";
            data.correct = (data.response===correct)?1:0;
          }
        }
      : {
          type: "html-keyboard-response",
          stimulus: generateNavonHTML(global_letter, local_letter),
          choices: ["h","s"],
          trial_duration: 1500,
          data: {block:block_type,trial:i+1,condition,task,global_letter,local_letter},
          on_finish:function(data){
            const correct = (task==="global"?global_letter:local_letter).toLowerCase();
            data.correct = data.response===null?0:(data.response===correct?1:0);
          }
        }
    );
  }
  return trials;
}


function saveData(){
  fetch(GOOGLE_SHEETS_URL,{
    method:"POST",
    headers:{"Content-Type":"text/plain"},
    body: JSON.stringify(
      jsPsych.data.get()
        .filterCustom(d=>d.block && !d.ignore)
        .values()
    )
  });
}


let timeline = [];

timeline.push(
  instructionScreen(`
    <h2>Neivona uzdevums</h2>
    <p>Informācijai: tiks parādīti S vai H burti, kas veidoti no maziem S vai H burtiem.</p>
    <p>Spied H, ja redzi H, ja S, tad S.</p>
    <p>Atbildes jāsniedz ātri, jo limits ir 1,5 sekundes.</p>
    <p>Ja testu veic datorā, nospied SPACE. Ja testu veic telefonā, spied pogu, lai turpinātu.</p>
  `)
);

timeline.push(
  instructionScreen(`
    <h2>Globālais bloks</h2>
    <p>Šajā blokā tev jākoncentrējas uz <strong>lielajiem burtiem</strong></p>
    <p>Lielais burts veidots no maziem burtiem - ignorē <strong>mazos burtiņus</strong></p>
    <p>Lai sāktu: ja testu veic datorā, nospied <strong>SPACE</strong>, ja telefonā — spied pogu.</p>
  `)
);
timeline.push(...createTrials("global",N_TRIALS_GLOBAL,"global"));

timeline.push(
  instructionScreen(`
    <h2>Lokālais bloks</h2>
    <p>Šajā blokā tev jākoncentrējas uz <strong>mazajiem burtiem</strong>.</p>
    <p>Mazie burtiņi veido lielo burtu - ignorē <strong>lielo burtu</strong>.</p>
    <p>Lai sāktu: ja testu veic datorā, nospied <strong>SPACE</strong>, ja telefonā — spied pogu.</p>
  `)
);
timeline.push(...createTrials("local",N_TRIALS_LOCAL,"local"));

timeline.push(
  instructionScreen(`
    <h2>Jauktais bloks</h2>
    <p>Šajā blokā dažreiz tev jākoncentrējas uz <strong>lielajiem burtiem</strong>, dažreiz uz <strong>mazajiem burtiem</strong>.</p>
    <p>Pirms katra uzdevuma ekrānā parādīsies bultiņa:</p>
      <p>↑ — fokusējies uz lielajiem burtiem (globālais uzdevums)</p>
      <p>↓ — fokusējies uz mazajiem burtiem (lokālais uzdevums)</p>
    <p>Lai sāktu: ja testu veic datorā, nospied <strong>SPACE</strong>, ja telefonā — spied pogu.</p>
  `)
);
timeline.push(...createTrials("mixed",N_TRIALS_MIXED));

timeline.push({
  type: "html-keyboard-response",
  stimulus: function () {

    const trials = jsPsych.data.get()
      .filterCustom(d =>
        d.correct !== undefined &&
        d.block !== undefined
      );

    function blockAccuracy(blockName) {
      const blockTrials = trials.filter({ block: blockName });
      if (blockTrials.count() === 0) return "—";
      return Math.round(blockTrials.select("correct").mean() * 100) + "%";
    }

    const globalAcc = blockAccuracy("global");
    const localAcc  = blockAccuracy("local");
    const mixedAcc  = blockAccuracy("mixed");

    const meanRT = Math.round(
      trials.filter({ correct: 1 }).select("rt").mean()
    );

    return `
      <h2>Paldies par dalību!</h2>

      <h3>Precizitāte pa blokiem</h3>
      <p><strong>Globālais bloks:</strong> ${globalAcc}</p>
      <p><strong>Lokālais bloks:</strong> ${localAcc}</p>
      <p><strong>Jauktais bloks:</strong> ${mixedAcc}</p>

      <p style="margin-top:15px;">
        <strong>Vidējais reakcijas laiks:</strong> ${meanRT} ms
      </p>
    `;
  },
  on_load: saveData,
  choices: jsPsych.NO_KEYS,
  data: { ignore: true }
});



jsPsych.init({ timeline });

</script>
</body>
</html>
